import os
import ubinascii
import pycom
from machine import SD
import os

from SCHC_FR.LoRaWAN_Pycom import LoRaWAN_Pycom
from SCHC_FR.SCHC_Fragmenter_Node import SCHC_Fragmenter_Node

def callback_tx_side():
    print("Calling callback function TX side")


pycom.heartbeat(False)
pycom.rgbled(0x00007f) # red

sd = SD()
os.mount(sd, '/sd')
# check the content
os.listdir('/sd')

tile_size = 10  # bytes
packet_size = 400    # bytes
data_rate = 3

mypycom = LoRaWAN_Pycom(data_rate)
s = mypycom.initialize_lorawan_link()

print("")
print("")
fragmenter = SCHC_Fragmenter_Node(SCHC_Fragmenter_Node.LoRaWAN)
mypycom.set_fragmenter(fragmenter)

fragmenter.set_callback(callback_tx_side)
fragmenter.set_lpwan_send_function(mypycom.send_tx_side)
fragmenter.set_lpwan_send_function_without_recv(mypycom.send_tx_side_without_recv)
fragmenter.set_lpwan_recv_function(mypycom.recv_tx_side)
fragmenter.set_data_rate(mypycom.get_data_rate())
fragmenter.set_tile_size(tile_size)
fragmenter.initialize()

print("**************************************************************************")
print("Tile Size: " + str(tile_size) + " bytes")
print("Packet Size: " + str(packet_size) + " bytes")
print("Data Rate: " + str(data_rate))
print("**************************************************************************")

for i in range(1):
    print("Creating SCHC packet nÂ°" + str(i))
    #schc_packet = ubinascii.unhexlify('61565a4354314a334d4574485a32394251554642546c4e56614556565a30464251554d77515546425158524451556c42515546444d57564957453542515546425156684f5531497753554679637a526a4e6c464251554642556d3552565446435155464465477033646a685a55565642515546425a316b7761464e55555546425a576c5a5155464a513056425155513251554642515764505a304642534656335155464563566c42515546506347644251554a6b6432354d63464a5151554642516d746b536c4a46526c565852575a30566a4a305457737859316b33626a567a646a645a637a4a685445707a6156673363336870656a5a4a643367794e307735625535466379393061586c31517a4d72593030315254567657566853536b4658516b467753586b3256555a7862326850627a4a5051326c6e53565a7556477073566d74444e58524d596d4d3152457848644752424e7a6c494e69395965576733646e4a694e336449623270585655706a4d48425056445671645667334e58707555453076656e5a315a6e4a4c4e48564d6154565457473952524568354d5546765448644e5356467754566c7163324e5a6156424965485644526d6c6d554863764b3142454e53394461584a494f48684d4c335a434e6d5a5759584a365a54563354306f7764576b34567a5a3562576470543068334b3234345a6d6f78563349785258467354556c775748493551566b7755574d796355565355454a6e5a4531695245746163484e56555763335431564d5a586449526d4645544463765755685765486848643164484d315130644774315a32466f596a424454314a3553304a53535578456355394c513077774b32355659556858616d59774b32645261475a5a614578555356467861546872536e5642556d68574d4539614e4446365a565254656b3530625578584e7a6c56655752465a453149556a526b516a5630566c703254554a785458427562544643625452734b3146424d303577646a6c5056476f34615768735a4468724e3277314d6e4e6a5647523562324657615645784f57383153323478525451794d32526b4d33526b55584e5153474a514e3256455a3235595269394263323477626d6452536c4a6e57545642516b4a4953327854615842554e6b6852523256475958517861556f325455464961466b33526d45726544684f6244466b5a54637261325a71546d39774e6c424f635551724e6c463252537453596a4e36546a4a575953396d54464a3257554e70596c64595557644e59544a7961444d35624539456453396a4d5751324e6a51335a47526c4f5374584c3352585557526b64577857566b31556156703364304a734e6e5a6b526d394f516e564f536e4e425345737a614546514d45525a4e314652546d39506347564a6554673154464e6d64566c4954446b7a59566c76534534326345566a563164574e5668694d57356e5279745a63797449656d744c655867726246705752587048525449344b3364685245396b656e5a45596d6c754f55464f6247397a55475978596a564f596d51304e6c6f3163306f354e4759306330357856584675626b56444d6e6c43516a6451526b4e744e6d64444e6e4a455557566e546d4e45616c647a5a6c4e6a4d585a305a4731436555355a4d6e6852646d394861544e79546a566c59693961596b3172646b39724d314261597a4e4e553341345655354361474d3053545a585a6b30355a4863724e797377596a6c4255556b7664316c55536d4a525444646b4e3239424d437449567a64515a6b316861556c4b517a5a42536c6c6b51566c794e444255516d63774e454a4e53305a495332786d5a3356434d546777576d703362317058564570304f55565657444d31616e565154303552656d684b51544e4f596c4a575747463563584a6861325a49536e4a42513349334d6d7074646e4e4956305a47636e52445532315a52454a5a643351724d334d72596b355961565a43593046545344497254554a45625652556330524e6432645164314a6a6158564355545a3256466f7259315a56564535355a6a42745a793930626c466e6132383453445a49526b7068576d525452445a7a56327372556d4932576b6b784d55387757445934596a646f4c306c355231684953445a465a464e4665555a4c523168756557643054486c315356526857476434554770464d556f324f545257636b7046656a5a7056335972646b6379616b39706145466e5432744c53464a6864555a46636c55304d3073315232703361446c7664334a444d6d74454b30464a4e485a4b516d6c5764446b336458565764474e735658567463475248576c5a36597a49335447557952474a5565486f33626a643354574a6b4f584a6c4e564e46596e5930546b78684c325a4a4d484a465547466b4b79737a65565653627a6c4c564668794d48425763576468616a4e5a61315a57555774795279746d54457861516d6332646b70686133687a4f57394d5a484d345a6d786c52555132624531456131566f5247704a6348526e59317035516a684862337049633155725132644e4f57684e4d576c74636a46594e7a4a525a315a58556a5930616b646d595539454f477376623356714d6d4a7352323831644574355179394d575842595a316876656b744761327461626a5643576e6433634746444c32524f656a686f62584e724e6c5245526d394a516d56326446687055544a6d4d6d7034523046765a6d5130593146545753744f56474a795932497a53564d3457584e4e646e42424d7a646e4f46466f566a5a6f57573545546e425857477732515868475554526c5356704661456b304f5731355a57356165576461616b704d564841764d32564a626d4e6e5354423463797471565664695a303555593146436545645656574e6f51556730556d526b55473530537a68345933424d566e5a6b5a6d746a6132593051553174566e6c4b596c644352456c4a5155357055336454655846766130526f64305a6e52584176646c466e4b304a4c5353744662325933525659724b7a68574f474e6b523170344e6c5274574449304d564978576e64685430356e626e7035524855775356523653554d32564752615445564a56466c504e3249334e5568725a5864514b306c514e5556784f4738785245394c5a575a565a584977516b64724d553170556b5a3252545651564842464b3268544d6a526f516a4e614e54424e62464250536d4653626e41785a6c557a5a6a6459624642794d453570565851324f45526a556e5a6f575468564e45564c4e3234724e55737663566732616c557a6232706e5a30314256464e5a54474a6f546b564557454e5a656b566f62314a4d5132394f56484272633052425a6b35456231526a57584e6f564574314f5664614b315674646a46365157705964564647535559354d31706e563056555a7974485231526c5348647a5a31567955457435634446315a326444525531425355743459573545546a6c5865454e4b5956426b6557523456305243516d316f53334a54554463334d336730646b68565344464a626d646e5344526e524668785a336c6f5558465755326c5755564978627a5651526a5a445632314f63485669563049354d454e725933524752556b3061573577526a426b52444e726446686c54336b78564539504e5664355a464a535a433949595870355a4870584d464d7a637a5a524f575a72546b466864316858636939774e564e4f57574e304d454e75633068535244493562314130645451794f464a734e574a334d4651316155745a656e5a5052464d3565476454517a6c794e4552554f484e4d4d476430536b6c4c62306c6c5a6e5a6954565675636a427a4c32394f61485a7356574e4f4e466c7656326c3262314a61596c4a4e516e4a4b53565a5956575246637974574e6e706a655652345643746b5432645a6343743551336b33566a417859544e765a6e645162306c6a4d465a30576d7474596e4a304f486332646d31564e31526e54586f335a5570785a6b5673566c557859303970556d784e654552355932565552575275526c705551566379526e45724d556c776430564b4c3039364f577048546e7075615730764e484a4464486c5556464a33524468546157567359306b7756445a574d6c4a556147563154544576626e6845524468556155684e564456705a6b5233646e467454437470554774714e573872566a4e36646939425445464962544d72526c5932645768425155464251555673526c52725533565262554e44')
    schc_packet = os.urandom(packet_size)  # in bytes
    print("SCHC packet len: " + str(len(schc_packet)))
    fragmenter.set_socket_lorawan(s)
    fragmenter.send(schc_packet)

print(fragmenter.total_times)


# try some standard file operations
name = '/sd/capture_' + str(packet_size) + '_bytes_' + str(tile_size) + '_byte_x_tile_DR_' + str(data_rate) + '.txt' # nombre del archivo de salida
f = open(name, 'w')
f.write(str(fragmenter.total_times))
f.close()
f = open(name, 'r')
f.readall()
f.close()

pycom.heartbeat(False)
pycom.rgbled(0x7f0000) # red
